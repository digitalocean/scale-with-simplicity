#cloud-config
# Route Droplet egress through NAT Gateway while preserving access to DigitalOcean metadata endpoint.
package_update: false
package_upgrade: false

write_files:
  - path: /etc/netplan/99-natgw.yaml
    permissions: '0644'
    content: |
      network:
        version: 2
        ethernets:
          eth0:
            routes:
              - to: 169.254.169.254/32
                via: ${original_gateway}
          eth1:
            routes:
              - to: 0.0.0.0/0
                via: ${nat_gateway_gateway_ip}

runcmd:
  - original_gw=$(curl -s http://169.254.169.254/metadata/v1/interfaces/public/0/ipv4/gateway)
  - ip route add 169.254.169.254 via $original_gw dev eth0 || true
  - ip route replace default via ${nat_gateway_gateway_ip}
  - netplan apply || true
